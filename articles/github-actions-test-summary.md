---
title: "GitHubActionsã§ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸ç‡ã‚’å‡ºåŠ›ã—ã¦ã‚³ãƒ¼ãƒ‰å“è³ªã‚’å¯è¦–åŒ–ã™ã‚‹"
emoji: "ğŸ“ˆ"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["php", "GitHubActions", "CI", "PHPUnit"]
published: true
---

ZennåˆæŠ•ç¨¿ï¼ï¼è‡ªç§°ã‚³ãƒ¼ãƒ‰å“è³ªä¿å…¨å§”å“¡ä¼šã§ã™ã€‚
GitHubActionsã‚’åˆ©ç”¨ã—ã¦ã€ä»¥ä¸‹ã®ã‚ˆã†ã«ãƒ—ãƒ«ãƒªã‚¯ã«ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸ç‡ã‚’å‡ºåŠ›ã—ãƒ¬ãƒ“ãƒ¥ã‚¢ãƒ¼ã«ãƒ†ã‚¹ãƒˆã‚’ã‚„ã£ã¦ã‚‹ã“ã¨ã‚’å¯è¦–åŒ–ã—ãŸã„ã¨æ€ã„ã¾ã™ã€‚
![Test_Coverrage_Summary](/images/github-actions-test-summary/Test_Coverrage_Summary.png)

ä»Šè‡ªåˆ†ãŒé–¢ã‚ã£ã¦ã„ã‚‹ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ã¯ã€ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰æ›¸ã‹ã‚Œã¦ã‚‚å®Ÿéš›ã«ãƒ†ã‚¹ãƒˆã®å®Ÿè¡Œç‡ã¯ç¾åœ¨ã©ã‚Œãã‚‰ã„ãªã®ã‹ã€ã±ã£ã¨è¦‹ã§ã¯åˆ†ã‹ã‚‰ãªã„ã®ã§æ•°å­—ã§å‡ºã™ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ã€‚ä¸–ã«ã¯ä»¥ä¸‹ã®ã‚ˆã†ãªã‚µãƒ¼ãƒ“ã‚¹ã§ãƒ†ã‚¹ãƒˆã®ã‚«ãƒãƒ¬ãƒƒã‚¸ã‚’è¨ˆæ¸¬ã—ã¦ã€å¯è¦–åŒ–ã™ã‚‹ã‚‚ã®ã‚‚ã‚ã‚Šã¾ã™ãŒã€ä»Šå›ã‚„ã‚ŠãŸã„ã®ã¯ã‚‚ã£ã¨ç°¡æ˜“çš„ãªã‚‚ã®ã€‚
GitHubã‚’ä½¿ç”¨ã—ãŸãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ã‚ã‚Œã°ã€ã©ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ã‚‚å°å…¥ã§ãã¾ã™ã€‚
â€»**Codecov**ã¯privateãƒªãƒã‚¸ãƒˆã‚’æ‰±ã†ã®ã¯æœ‰æ–™

[Codecovã‚’ä½¿ã£ã¦ã‚«ãƒãƒ¬ãƒƒã‚¸ã‚’è¨ˆæ¸¬ã™ã‚‹](https://qiita.com/nasum/items/aff9bf09d49b136bbf94)
[Codecov](https://about.codecov.io/)

â€»å½“è¨˜äº‹ã§ã¯PHPã¨PHPUnitã‚’ä½¿ç”¨ã—ã¦ã„ã¾ã™ãŒã€GitHubActionsã‚’ä½¿ç”¨ã—ãŸBotã‚³ãƒ¡ãƒ³ãƒˆã®æ–¹æ³•ãªã©ã¯ä»–ã®è¨€èªã¨ã‹ã§ã‚‚æµç”¨å‡ºæ¥ã‚‹ã®ã§è¦‹ã¦ãã ã•ã„ã¾ã—

**ã“ã®è¨˜äº‹ã§èª¬æ˜ã™ã‚‹ã“ã¨**

- ã‚«ãƒãƒ¬ãƒƒã‚¸ç‡ã®ã‚µãƒãƒªãƒ¼ã®å‡ºã—æ–¹
- PullRequestã¸è‡ªå‹•ã‚³ãƒ¡ãƒ³ãƒˆã®æŠ•ç¨¿

**ã“ã®è¨˜äº‹ã§èª¬æ˜ã—ãªã„ã“ã¨**
- UnitTestã®èª¬æ˜
- GitHubActionsã®åˆæœŸè¨­å®šãªã©

**ã“ã®è¨˜äº‹ã§ä½¿ç”¨ã—ãŸç’°å¢ƒãªã©**
- PHP 8.0.13
- Laravel Framework 6.20.43
- PHPUnit 9.5.10
```shell
root@11c4d9a174c5:/var/www/test# php -v
PHP 8.0.13 (cli) (built: Nov 19 2021 22:11:30) ( NTS )
Copyright (c) The PHP Group
Zend Engine v4.0.13, Copyright (c) Zend Technologies
    with Xdebug v3.1.1, Copyright (c) 2002-2021, by Derick Rethans

root@11c4d9a174c5:/var/www/test# php artisan -V
Laravel Framework 6.20.43

root@11c4d9a174c5:/var/www/test# php vendor/phpunit/phpunit/phpunit --version
PHPUnit 9.5.10 by Sebastian Bergmann and contributors.
```


### 1: UnitTestã‚’å®Ÿè¡Œã™ã‚‹

```yml
      - name: Execute Test
        run: |
          php artisan config:clear
          php vendor/phpunit/phpunit/phpunit --coverage-text --colors=never > storage/logs/coverage.log
          cat storage/logs/coverage.log
```

1. `php artisan config:clear`
    ãŠã¾ã˜ãªã„
2. `php vendor/phpunit/phpunit/phpunit --coverage-text --colors=never > storage/logs/coverage.log`
    ã“ã“ãŒå‘³å™Œ
3. `cat storage/logs/coverage.log`
    ã‚ã£ã¦ã‚‚ãªãã¦ã‚‚è‰¯ã„ã‘ã©ã€ä¸€å¿œç´°ã‹ã„ãƒ†ã‚¹ãƒˆçµæœã®ç¢ºèªç”¨ã«ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«å‡ºåŠ›ã™ã‚‹

phpunitã§ã¯ãƒ†ã‚¹ãƒˆçµæœã®å‡ºåŠ›å½¢å¼ã‚’é¸ã¶ã“ã¨ãŒã§ãã¾ã™ã€‚
å‡ºåŠ›å½¢å¼ã¯ä»¥ä¸‹ã®ã‚ˆã†ãªã‚‚ã®ãŒã‚ã‚Šã¾ã™ãŒã€ä»Šå›ã¯ãƒ†ã‚­ã‚¹ãƒˆå½¢å¼ã§å‡ºåŠ›

```bash
--coverage-clover <file>    Generate code coverage report in Clover XML format
--coverage-cobertura <file> Generate code coverage report in Cobertura XML format
--coverage-crap4j <file>    Generate code coverage report in Crap4J XML format
--coverage-html <dir>       Generate code coverage report in HTML format
--coverage-php <file>       Export PHP_CodeCoverage object to file
# ã“ã‚Œã‚’ä½¿ç”¨
--coverage-text=<file>      Generate code coverage report in text format [default: standard output]
--coverage-xml <dir>        Generate code coverage report in PHPUnit XML forma
```

ã‹ã¤ã€`--colors=never`ã‚’æŒ‡å®šã—ã¦ã€è‰²å‡ºåŠ›ã—ãªã„ã‚ˆã†ã«ã—ã¾ã™
ãƒ­ãƒ¼ã‚«ãƒ«ã§å®Ÿè¡Œã™ã‚‹æ™‚ãªã©ã¯ã€è‰²ã‚’æŒ‡å®šã—ãŸæ–¹ãŒè¦‹ã‚„ã™ã„ã§ã™ãŒã€ç‰¹å®šã®è‰²ã‚³ãƒ¼ãƒ‰ã®ã‚¿ã‚°ãŒåŸ‹ã‚è¾¼ã¾ã‚Œã¦ã—ã¾ã†ã®ã§å¤–ã—ã¾ã™ã€‚

### 2: UnitTestã®å¤±æ•—ç†ç”±ã‚’å‡ºåŠ›ã™ã‚‹
```yml
      - name: Cat Test Result
        run: |
          cat storage/logs/coverage.log
        if: ${{ failure() }}
```

å…ˆã»ã©ã®ãƒ†ã‚¹ãƒˆå®Ÿè¡Œã§ãƒ†ã‚¹ãƒˆçµæœã‚’ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã«æ›¸ãå‡ºã—ã¾ã—ãŸã€‚
ãã‚Œã‚’ãƒ†ã‚¹ãƒˆãŒå¤±æ•—ã—ã€è½ã¡ã¦ã—ã¾ã£ãŸæ™‚ã‚‚å‡ºåŠ›ã™ã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚
ã“ã‚Œã‚’æŒ‡å®šã—ãªã„ã¨ã€ãƒ†ã‚¹ãƒˆãŒå¤±æ•—ã—ã¦ã‚³ã‚±ãŸå ´åˆã«ä½•ã‚‚å‡ºåŠ›ã•ã‚Œãªã„ã®ã§ã€‚
```
# GitHubActionså´ã§ã“ã®å‡ºåŠ›ã ã‘ã§çµ‚ã‚ã‚‹
Error: Process completed with exit code 2.
```

`if: ${{ failure() }}`ã§ãƒ—ãƒ­ã‚»ã‚¹ãŒå¤±æ•—ã—ãŸã¨ãã ã‘å®Ÿè¡Œã—ã¦ãã‚Œã¾ã™ã€‚


## 3: UnitTestã®çµæœã‚’ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã™ã‚‹
```yml
      - name: Sed Coverage Report
        run: |
          sed -E "s/"$'\E'"\[([0-9]{1,2}(;[0-9]{1,2})*)?m//g" | \
          grep "Code Coverage Report:" -A6 storage/logs/coverage.log | sed -e "s/^ *//" | sed -e "s/ *$//" | sed -e "/^ *$/d" > storage/logs/coverage-summary.log
```
å‡ºåŠ›ã—ãŸã„å†…å®¹ã ã‘æŠœãå–ã‚Šã¾ã™ã€‚

### 4: UnitTestã®çµæœã‚’èª­ã¿è¾¼ã‚€
```yml
      - name: Read coverage summary
        id: coverage-summary
        uses: juliangruber/read-file-action@v1
        with:
          path: ./src/storage/logs/coverage-summary.log
```
èª­ã¿è¾¼ã‚€ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æŒ‡å®šã—ã¾ã™ã€‚
ä¸Šè¨˜ã§å‡ºåŠ›çµæœã‚’ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã—ãŸãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚‹ã®ã§ãã¡ã‚‰ã‚’æŒ‡å®šã€‚
`id`ã¯ã“ã®å¾Œã®ãƒ—ãƒ­ã‚»ã‚¹ã§ä½¿ç”¨ã™ã‚‹ã®ã§ã€å¿…ãšæŒ‡å®šã—ã¦ãã ã•ã„ã€‚

### 5: UnitTestã®çµæœ(ãƒ¬ãƒãƒ¼ãƒˆ)ã‚’GitHubã§è‡ªå‹•ã§ã‚³ãƒ¡ãƒ³ãƒˆã™ã‚‹

```yml
      - name: Comment Coverage Summary
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          header: coverage-summary
          message: |
            ## Coverage Summary
            ${{ steps.coverage-summary.outputs.content }}
```

messageã®éƒ¨åˆ†ãŒå®Ÿéš›ã«ã‚³ãƒ¡ãƒ³ãƒˆã™ã‚‹å†…å®¹ã€‚
` ${{ steps.å…ˆã»ã©æŒ‡å®šã—ãŸãƒ—ãƒ­ã‚»ã‚¹ID.outputs.content }}`
ä¸Šè¨˜ã® **3: UnitTestã®çµæœã‚’èª­ã¿è¾¼ã‚€** ã§æŒ‡å®šã—ãŸIDã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã§ã€ã“ã¡ã‚‰ã§ãƒ†ã‚¹ãƒˆçµæœã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‡ºåŠ›ã™ã‚‹ã“ã¨ãŒå¯èƒ½ã§ã™ã€‚

ã“ã®Actionã®ä¾¿åˆ©ãªã¨ã“ã‚ã¯ã€æ–°è¦ã«ã‚³ãƒ¡ãƒ³ãƒˆã‚’è¡Œã†ã®ã§ã¯ãªãã€ã‚³ãƒ¡ãƒ³ãƒˆã‚’ä¸Šæ›¸ãã—ã¦ãã‚Œã‚‹ã¨ã“ã‚ã€‚å±¥æ­´ã‚‚æ®‹ã‚Šã¾ã™ã€‚
![GitHub_Comment_Rivision](/images/github-actions-test-summary/GitHub_Comment_Rivision.png)

ãªã®ã§ã€ãƒ†ã‚¹ãƒˆãŒå®Ÿè¡Œã•ã‚Œã‚‹åº¦ã«ä¸Šæ›¸ãã‚’è¡Œã£ã¦ãã‚Œã‚‹ã®ã§ä»¥ä¸‹ã®ã‚ˆã†ã«ä¸å¿…è¦ã«ã‚³ãƒ¡ãƒ³ãƒˆãŒè¤‡æ•°ç”Ÿæˆã•ã‚Œã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã›ã‚“ã€‚
![UnitTest_Comment_Collection](/images/github-actions-test-summary/UnitTest_Comment_Collection.png)


### 6: UnitTestã®çµæœã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹
```yml
      - name: Archive code coverage results
        uses: actions/upload-artifact@v2
        with:
          name: code-coverage-report
          path: ./src/storage/logs/coverage-summary.log
```
å¿…è¦ãªäººã ã‘å‘ã‘ã€‚
ãƒ†ã‚¹ãƒˆçµæœã‚’ãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ã§ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãŠãã¾ã™ã€‚ï¼ˆãƒ†ã‚¹ãƒˆæˆæœç‰©ã¨ã—ã¦ï¼Ÿï¼‰
å®Ÿéš›ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã®ã§ã‚ã‚Œã°ã€HTMLå½¢å¼ã®æ–¹ãŒè¦‹ã‚„ã™ã„ã¨æ€ã†ã®ã§ãã“ã¯é©å®œã€‚


### UnitTest Workflow å…¨ä½“å›³

```yml
name: UnitTest
on: [pull_request]

jobs:
  unit-test:
    runs-on: ubuntu-latest

    services:
      mysql:
        image: mysql:8.0
        ports:
          - 3306:3306
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_PASSWORD: root
          MYSQL_DATABASE: database
          MYSQL_USER: user

        options: >-
          --health-cmd "mysqladmin ping -h localhost"
          --health-interval 20s
          --health-timeout 10s
          --health-retries 10

    env:
      DB_CONNECTION: mysql
      MYSQL_ALLOW_EMPTY_PASSWORD: yes
      DB_HOST: 127.0.0.1
      DB_PORT: 3306
      DB_DATABASE: root
      DB_USERNAME: database
      DB_PASSWORD: user

    defaults:
      run:
        working-directory: ./src

    steps:
      - uses: actions/checkout@v2

      - name: SetUp PHP
        uses: shivammathur/setup-php@master
        with:
          php-version: '8.0'
          extension-csv: mbstring, xdebug

      - name: Cache vendor
        id: cache
        uses: actions/cache@v1
        with:
          path: ./vendor
          key: ${{ runner.os }}-composer-${{ hashFiles('./composer.lock') }}
          restore-keys: |
            ${{ runner.os }}-composer-

      - name: Composer install
        if: steps.cache.outputs.cache-hit != 'true'
        run: composer install -n --prefer-dist

      - name: Composer Dump Autoload
        run: composer dump-autoload -q

      - name: Laravel Settings
        run: |
          cp .env.CI .env
          php artisan key:generate
          chmod -R 777 storage bootstrap/cache        

      - name: Laravel Migrate
        run:
          php artisan migrate:fresh --seed
      
      - name: Execute Test
        run: |
          php artisan config:clear
          php vendor/phpunit/phpunit/phpunit --coverage-text --colors=never > storage/logs/coverage.log
          cat storage/logs/coverage.log

      - name: Cat Test Result
        run: |
          cat storage/logs/coverage.log
        if: ${{ failure() }}

      - name: Sed Coverage Report
        run: |
          sed -E "s/"$'\E'"\[([0-9]{1,2}(;[0-9]{1,2})*)?m//g" | \
          grep "Code Coverage Report:" -A6 storage/logs/coverage.log | sed -e "s/^ *//" | sed -e "s/ *$//" | sed -e "/^ *$/d" > storage/logs/coverage-summary.log

      - name: Read coverage summary
        id: coverage-summary
        uses: juliangruber/read-file-action@v1
        with:
          path: ./src/storage/logs/coverage-summary.log

      - name: Comment Coverage Summary
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          header: coverage-summary
          message: |
            ## Coverage Summary
            ${{ steps.coverage-summary.outputs.content }}

      - name: Archive code coverage results
        uses: actions/upload-artifact@v2
        with:
          name: code-coverage-report
          path: ./src/storage/logs/coverage-summary.log
```

#### æœ€å¾Œã«

ãƒ†ã‚¹ãƒˆã®å¯è¦–åŒ–å¤§äº‹ã€‚ï¼ˆè‡ªå‹•åŒ–ã™ã‚‹ã®ã‚‚å¤§äº‹ï¼‰
ãƒ†ã‚¹ãƒˆãŒå¤§äº‹ãªã®ã¯è¨€ã‚ãšã‚‚ãŒãªã§ã™ãŒã€ã€Œã“ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®å‰ã‹ã‚‰ã‚ã‚‹ã‘ã©ã€å“è³ªã£ã¦ã©ã†ãªã®ï¼Ÿã€ã¨å‰ã„äººã«è¨€ã‚ã‚ŒãŸã¨ãã«ã€ãƒ†ã‚¹ãƒˆè‡ªä½“(æˆæœç‰©)ã¨ãã®å ±å‘Šã§ãã‚‹æ•°å­—(æˆæœç‰©ã®ã‚¨ãƒ“ãƒ‡ãƒ³ã‚¹)ãŒã‚ã‚‹ã¨ã€è«¸ã€…ä¾¿åˆ©ã ãªã£ã¦ã“ã¨ãŒåˆ†ã‹ã£ã¦ãã¾ã—ãŸã€‚

å‰ã„äººã‹ã‚‰ã—ãŸã‚Šã€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‹ã‚‰é–¢ã‚ã£ã¦ã„ãªã„äººã‹ã‚‰ã™ã‚‹ã¨ã€æ•°å­—çš„ãªæŒ‡æ¨™ãŒãªã„ã¨ã€Œå‹•ã„ã¦ã‚‹ã‹ã‚‰ã¨ã‚Šã‚ãˆãšã¯å¹³æ°—ãªã‚‚ã®ãªã‚“ã‹ï¼Ÿã€ã€Œå“è³ªã¯å¤§ä¸ˆå¤«ãªã‚“ã‹ï¼Ÿã€ã¨ä¸å®‰ææ–™ãŒæ®‹ã‚Šã¾ã™ã€‚

ãŸã ã€ã“ã†ã„ã£ãŸãƒ†ã‚¹ãƒˆçµæœã‚’æ•°å­—ã§è¦‹ã›ã‚‰ã‚Œã‚‹ã¨ã“ã‚ã«æ®‹ã—ç¶šã‘ã¦ãŠã‘ã°ã€å‰ã„äººã‚‚ä»Šå¾Œãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«é–¢ã‚ã‚‹äººã‚‚è«¸ã€…å®‰å¿ƒææ–™ã¨ã—ã¦å‹•ãã‚„ã™ããªã‚‹ã®ã‹ãªã‚ã¨ã€‚æ”¹å–„ã‚ã‚‹ã®ã¿ã€œã€‚

**â€»Follow&â¤ï¸ã—ã¦ãã‚Œã‚‹ã¨åŠ±ã¿ã«ãªã‚Šã¾ã™**
#### å‚è€ƒè¨˜äº‹

- [GitHub Actionsã§ã‚«ãƒãƒ¬ãƒƒã‚¸ã‚’å¯è¦–åŒ–ã™ã‚‹
](https://zenn.dev/katzumi/articles/995df5abebc91e312167)